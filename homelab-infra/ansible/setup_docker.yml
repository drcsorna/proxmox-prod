---
- name: Install Docker and deploy service stack with secrets
  hosts: docker_hosts
  become: yes
  vars:
    docker_dir: "/home/{{ ansible_user }}/docker"
    secrets_dir: "/opt/secrets"
  
  tasks:
    # ====================================
    # System Updates
    # ====================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    # ====================================
    # Docker Installation (Ubuntu 24.04)
    # ====================================
    - name: Install prerequisite packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Docker GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /tmp/docker.gpg
        mode: '0644'

    - name: Add Docker GPG key to apt keyrings
      shell: |
        gpg --dearmor < /tmp/docker.gpg > /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    # ====================================
    # Directory Setup
    # ====================================
    - name: Create secrets directory
      file:
        path: "{{ secrets_dir }}"
        state: directory
        mode: '0700'
        owner: root
        group: root

    - name: Create Docker service directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop:
        - "{{ docker_dir }}"
        - "{{ docker_dir }}/npm/data"
        - "{{ docker_dir }}/npm/letsencrypt"
        - "{{ docker_dir }}/code-server/config"
        - "{{ docker_dir }}/paperless/data"
        - "{{ docker_dir }}/paperless/media"
        - "{{ docker_dir }}/paperless/export"
        - "{{ docker_dir }}/paperless/consume"
        - "{{ docker_dir }}/paperless-postgres"
        - "{{ docker_dir }}/paperless-redis"
        - "{{ docker_dir }}/uptime-kuma"
        - "{{ docker_dir }}/tandoor/staticfiles"
        - "{{ docker_dir }}/tandoor/mediafiles"
        - "{{ docker_dir }}/tandoor-postgres"
        - "{{ docker_dir }}/sandbox-postgres"
        - "{{ docker_dir }}/homepage/config"

    # ====================================
    # Generate Secrets (Idempotent)
    # ====================================
    - name: Check existing secrets
      stat:
        path: "{{ secrets_dir }}/{{ item }}"
      register: secret_files
      loop:
        - code_server_password
        - code_server_sudo_password
        - paperless_db_password
        - paperless_secret_key
        - paperless_admin_password
        - tandoor_db_password
        - tandoor_secret_key
        - sandbox_db_password

    - name: Generate missing secrets
      shell: openssl rand -base64 32 | tr -d '\n'
      register: generated_secrets
      loop: "{{ secret_files.results }}"
      when: not item.stat.exists
      no_log: true

    - name: Save generated secrets
      copy:
        content: "{{ item.stdout }}"
        dest: "{{ secrets_dir }}/{{ item.item.item }}"
        mode: '0400'
        owner: root
        group: root
      loop: "{{ generated_secrets.results }}"
      when: item.stdout is defined
      no_log: true

    - name: Read all secrets for .env templating
      slurp:
        src: "{{ secrets_dir }}/{{ item }}"
      register: secrets_content
      loop:
        - code_server_password
        - code_server_sudo_password
        - paperless_db_password
        - paperless_secret_key
        - paperless_admin_password
        - tandoor_db_password
        - tandoor_secret_key
        - sandbox_db_password
      no_log: true

    # ====================================
    # Create .env from secrets
    # ====================================
    - name: Template .env file from secrets
      copy:
        content: |
          # code-server Configuration
          CODE_SERVER_PASSWORD={{ secrets_content.results[0].content | b64decode }}
          CODE_SERVER_SUDO_PASSWORD={{ secrets_content.results[1].content | b64decode }}

          # Paperless-ngx Configuration
          PAPERLESS_DB_PASSWORD={{ secrets_content.results[2].content | b64decode }}
          PAPERLESS_SECRET_KEY={{ secrets_content.results[3].content | b64decode }}
          PAPERLESS_ADMIN_USER=admin
          PAPERLESS_ADMIN_PASSWORD={{ secrets_content.results[4].content | b64decode }}
          PAPERLESS_ADMIN_EMAIL=drcsorna@gmail.com

          # Tandoor Recipes Configuration
          TANDOOR_DB_PASSWORD={{ secrets_content.results[5].content | b64decode }}
          TANDOOR_SECRET_KEY={{ secrets_content.results[6].content | b64decode }}

          # Sandbox PostgreSQL Configuration
          SANDBOX_DB_PASSWORD={{ secrets_content.results[7].content | b64decode }}
        dest: "{{ docker_dir }}/.env"
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      no_log: true

    # ====================================
    # Deploy Docker Compose Stack
    # ====================================
    - name: Copy docker-compose.yml
      copy:
        src: files/docker-compose.yml
        dest: "{{ docker_dir }}/docker-compose.yml"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'

    - name: Copy Homepage configuration files
      copy:
        src: "files/homepage/{{ item }}"
        dest: "{{ docker_dir }}/homepage/config/{{ item }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      loop:
        - services.yaml
        - widgets.yaml
        - settings.yaml

    # ====================================
    # Start Services
    # ====================================
    - name: Start Docker Compose stack
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dir }}"
        state: present
      become_user: "{{ ansible_user }}"

    # ====================================
    # FIX: Paperless-ngx Redis Persistence
    # ====================================
    - name: Disable Redis persistence safety check (MISCONF fix)
      command: docker exec paperless-redis redis-cli config set stop-writes-on-bgsave-error no
      changed_when: true
      # This task executes the fix command inside the running container

    - name: Restart Paperless-ngx container to apply Redis change
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dir }}"
        services:
          - paperless
        state: restarted
      become_user: "{{ ansible_user }}"

    # ====================================
    # Restart Tandoor Stack
    # ====================================
    - name: Restart Tandoor container for final initialization
      community.docker.docker_compose_v2:
        project_src: "{{ docker_dir }}"
        services:
          - tandoor
        state: restarted
      become_user: "{{ ansible_user }}"

    # ====================================
    # Deployment Complete
    # ====================================
    - name: Display deployment status
      debug:
        msg: |
          âœ… Flow Infrastructure Deployed Successfully
          
          Services: http://{{ ansible_host }}:81 (NPM), :8000 (Paperless), :8080 (Tandoor), :3001 (Uptime Kuma), :3000 (Homepage), :8443 (Code-Server)
          
          Secrets stored: {{ secrets_dir }}/ (mode 400, root-only)
          Config file: {{ docker_dir }}/.env (mode 600, generated from secrets)
          
          All services started automatically.