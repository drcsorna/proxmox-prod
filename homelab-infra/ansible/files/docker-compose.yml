version: '3.8'

services:
  # ==========================================
  # Nginx Proxy Manager - Reverse Proxy
  # ==========================================
  npm:
    image: jc21/nginx-proxy-manager:latest
    container_name: npm
    restart: unless-stopped
    ports:
      - '80:80'     # HTTP
      - '443:443'   # HTTPS
      - '81:81'     # Admin UI
    environment:
      - DISABLE_IPV6=true
    volumes:
      - ./npm/data:/data
      - ./npm/letsencrypt:/etc/letsencrypt
    networks:
      - services

  # ==========================================
  # code-server - VS Code in Browser
  # ==========================================
  code-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    restart: unless-stopped
    ports:
      - '8443:8443'
    environment:
      - PUID=1000  # Hardcoded for homelab: cloud-init guarantees first user is UID 1000
      - PGID=1000
      - TZ=Europe/Amsterdam
      - PASSWORD=${CODE_SERVER_PASSWORD}
      - SUDO_PASSWORD=${CODE_SERVER_SUDO_PASSWORD}
    volumes:
      - ./code-server/config:/config
      - /home/drcsorna/docker:/workspace/docker
    networks:
      - services

  # ==========================================
  # Paperless-ngx - Document Management
  # ==========================================
  paperless-redis:
    image: redis:7-alpine
    container_name: paperless-redis
    restart: unless-stopped
    volumes:
      - ./paperless-redis:/data
    networks:
      - services
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3

  paperless-postgres:
    image: postgres:16-alpine
    container_name: paperless-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=paperless
      - POSTGRES_USER=paperless
      - POSTGRES_PASSWORD=${PAPERLESS_DB_PASSWORD}
    volumes:
      - ./paperless-postgres:/var/lib/postgresql/data  # Bind mount: easier backups than named volumes
    networks:
      - services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U paperless"]
      interval: 30s
      timeout: 5s
      retries: 3

  paperless:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped
    depends_on:
      - paperless-postgres
      - paperless-redis
    ports:
      - '8000:8000'
    environment:
      # Database
      - PAPERLESS_REDIS=redis://paperless-redis:6379
      - PAPERLESS_DBHOST=paperless-postgres
      - PAPERLESS_DBNAME=paperless
      - PAPERLESS_DBUSER=paperless
      - PAPERLESS_DBPASS=${PAPERLESS_DB_PASSWORD}
      
      # General
      - PAPERLESS_URL=https://paperless.bubcsi.com
      - PAPERLESS_SECRET_KEY=${PAPERLESS_SECRET_KEY}
      - PAPERLESS_TIME_ZONE=Europe/Amsterdam
      - PAPERLESS_OCR_LANGUAGE=eng
      
      # Admin user
      - PAPERLESS_ADMIN_USER=${PAPERLESS_ADMIN_USER}
      - PAPERLESS_ADMIN_PASSWORD=${PAPERLESS_ADMIN_PASSWORD}
      - PAPERLESS_ADMIN_MAIL=${PAPERLESS_ADMIN_EMAIL}
      
      # UID/GID mapping
      - USERMAP_UID=1000
      - USERMAP_GID=1000
    volumes:
      - ./paperless/data:/usr/src/paperless/data
      - ./paperless/media:/usr/src/paperless/media
      - ./paperless/export:/usr/src/paperless/export
      - ./paperless/consume:/usr/src/paperless/consume
    networks:
      - services

  # ==========================================
  # Uptime Kuma - Service Monitoring
  # ==========================================
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    ports:
      - '3001:3001'
    volumes:
      - ./uptime-kuma:/app/data
    networks:
      - services

  # ==========================================
  # Tandoor Recipes - Recipe Management
  # ==========================================
  tandoor-postgres:
    image: postgres:16-alpine
    container_name: tandoor-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=tandoor
      - POSTGRES_USER=tandoor
      - POSTGRES_PASSWORD=${TANDOOR_DB_PASSWORD}
    volumes:
      - ./tandoor-postgres:/var/lib/postgresql/data
    networks:
      - services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tandoor"]
      interval: 30s
      timeout: 5s
      retries: 3

  tandoor:
    image: vabene1111/recipes:latest
    container_name: tandoor
    restart: unless-stopped
    depends_on:
      - tandoor-postgres
    ports:
      - '8080:8080'
    environment:
      - SECRET_KEY=${TANDOOR_SECRET_KEY}
      - DB_ENGINE=django.db.backends.postgresql
      - POSTGRES_HOST=tandoor-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=tandoor
      - POSTGRES_PASSWORD=${TANDOOR_DB_PASSWORD}
      - POSTGRES_DB=tandoor
      - TIMEZONE=Europe/Amsterdam
      - FRACTION_PREF=0
      - COMMENT_PREF=1
    volumes:
      - ./tandoor/staticfiles:/opt/recipes/staticfiles
      - ./tandoor/mediafiles:/opt/recipes/mediafiles
    networks:
      - services

  # ==========================================
  # Sandbox PostgreSQL - Self-Made Apps
  # ==========================================
  sandbox-postgres:
    image: postgres:16-alpine
    container_name: sandbox-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sandbox
      - POSTGRES_PASSWORD=${SANDBOX_DB_PASSWORD}
      # NOTE: No POSTGRES_DB - application databases created manually in Phase 4
    volumes:
      - ./sandbox-postgres:/var/lib/postgresql/data
    networks:
      - services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sandbox"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ==========================================
  # Homepage - Dashboard
  # ==========================================
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Amsterdam
    volumes:
      - ./homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker integration
    networks:
      - services

networks:
  services:
    driver: bridge
