version: "3.8"

# VM 210 Media Stack
# Includes: Jellyfin, *arr apps, qBittorrent+VPN, Immich

networks:
  media:
    driver: bridge
    ipam:
      config:
        - subnet: {{ docker_network_subnet }}

services:
  # ===========================================================================
  # VPN + TORRENT CLIENT
  # ===========================================================================
  
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "{{ qbittorrent_port }}:{{ qbittorrent_port }}"  # qBittorrent WebUI
      - "6881:6881"                                       # qBittorrent TCP
      - "6881:6881/udp"                                   # qBittorrent UDP
      - "{{ prowlarr_port }}:{{ prowlarr_port }}"        # Prowlarr via VPN
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_CITIES=${SERVER_CITIES}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/gluetun:/gluetun
    networks:
      media:
        ipv4_address: {{ gluetun_ip }}
    restart: unless-stopped

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
      - WEBUI_PORT={{ qbittorrent_port }}
    volumes:
      - /mnt/flash/qbittorrent:/config
      - /mnt/tank:/data
    restart: unless-stopped

  # ===========================================================================
  # INDEXER MANAGER
  # ===========================================================================

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      - gluetun
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/prowlarr:/config
    restart: unless-stopped

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    ports:
      - "{{ flaresolverr_port }}:8191"
    environment:
      - LOG_LEVEL=info
      - TZ={{ timezone }}
    networks:
      - media
    restart: unless-stopped

  # ===========================================================================
  # *ARR APPS
  # ===========================================================================

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    ports:
      - "{{ sonarr_port }}:8989"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/sonarr:/config
      - /mnt/tank:/data
    networks:
      - media
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    ports:
      - "{{ radarr_port }}:7878"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/radarr:/config
      - /mnt/tank:/data
    networks:
      - media
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    ports:
      - "{{ bazarr_port }}:6767"
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/bazarr:/config
      - /mnt/tank/media:/data/media
    networks:
      - media
    restart: unless-stopped

  # ===========================================================================
  # MEDIA SERVERS
  # ===========================================================================

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    ports:
      - "{{ jellyfin_port }}:8096"
      - "8920:8920"     # HTTPS
      - "7359:7359/udp" # Discovery
      - "1900:1900/udp" # DLNA
    environment:
      - PUID={{ media_uid }}
      - PGID={{ media_gid }}
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/jellyfin:/config
      - /mnt/tank/media:/data/media:ro
      # Intel Arc A380 hardware transcoding
      - /usr/lib/x86_64-linux-gnu/libOpenCL.so.1:/usr/lib/x86_64-linux-gnu/libOpenCL.so.1:ro
      - /etc/OpenCL:/etc/OpenCL:ro
      - /usr/lib/x86_64-linux-gnu/intel-opencl:/usr/lib/x86_64-linux-gnu/intel-opencl:ro
    devices:
      - /dev/dri:/dev/dri
    networks:
      - media
    restart: unless-stopped

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    ports:
      - "{{ jellyseerr_port }}:5055"
    environment:
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/jellyseerr:/app/config
    networks:
      media:
        ipv4_address: {{ jellyseerr_ip }}
    restart: unless-stopped

  # ===========================================================================
  # IMMICH - Photo Management with AI
  # ===========================================================================

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    command: ['start.sh', 'immich']
    ports:
      - "{{ immich_server_port }}:3001"
    environment:
      - DB_HOSTNAME=immich-postgres
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
      - TZ={{ timezone }}
    volumes:
      - /mnt/tank/photos:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    devices:
      - /dev/dri:/dev/dri  # Intel Arc A380 for ML/transcoding
    depends_on:
      - immich-redis
      - immich-postgres
    networks:
      - media
    restart: unless-stopped

  immich-microservices:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-microservices
    command: ['start.sh', 'microservices']
    environment:
      - DB_HOSTNAME=immich-postgres
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
      - TZ={{ timezone }}
    volumes:
      - /mnt/tank/photos:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    devices:
      - /dev/dri:/dev/dri  # Intel Arc A380 for ML/transcoding
    depends_on:
      - immich-redis
      - immich-postgres
    networks:
      - media
    restart: unless-stopped

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-ml
    ports:
      - "{{ immich_ml_port }}:3003"
    environment:
      - TZ={{ timezone }}
    volumes:
      - /mnt/flash/immich/model-cache:/cache
    devices:
      - /dev/dri:/dev/dri  # Intel Arc A380 for ML acceleration
    networks:
      - media
    restart: unless-stopped

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    networks:
      - media
    restart: unless-stopped

  immich-postgres:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-postgres
    environment:
      - POSTGRES_USER=immich
      - POSTGRES_PASSWORD=${IMMICH_DB_PASSWORD}
      - POSTGRES_DB=immich
    volumes:
      - /mnt/flash/immich/postgres:/var/lib/postgresql/data
    networks:
      - media
    restart: unless-stopped
